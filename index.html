<!DOCTYPE html>
<html>
<head>
  <title>Voice To-Do List</title>
</head>
<body>
  <h2>Record Audio & Manage To-Do List</h2>

  <button id="startBtn">Start Recording</button>
  <button id="stopBtn" disabled>Stop Recording</button>
  <p id="status"></p>

  <h3>Transcribed Command:</h3>
  <pre id="result"></pre>

  <button id="processBtn" disabled>Process Command</button>

  <h3>Current To-Do List:</h3>

  <!-- NEW TABLE RENDERING -->
  <table id="todoTable" border="1" cellpadding="5">
    <thead>
      <tr>
        <th>Task</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let mediaRecorder;
    let audioChunks = [];

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const status = document.getElementById("status");
    const result = document.getElementById("result");
    const processBtn = document.getElementById("processBtn");

    let lastTranscribedText = "";

    // ---------- NEW: TABLE RENDER FUNCTION ----------
    function renderTable(todoObj) {
      const tbody = document.querySelector("#todoTable tbody");
      tbody.innerHTML = ""; // Clear existing

      for (const key in todoObj) {
        const row = document.createElement("tr");

        const keyCell = document.createElement("td");
        keyCell.textContent = key;

        const valueCell = document.createElement("td");
        valueCell.textContent = todoObj[key];

        row.appendChild(keyCell);
        row.appendChild(valueCell);

        tbody.appendChild(row);
      }
    }

    // ---------- AUDIO RECORDING ----------
    startBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

      mediaRecorder.onstop = async () => {
        status.textContent = "Transcribing...";
        const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
        const formData = new FormData();
        formData.append("file", audioBlob, "audio.wav");

        try {
          const response = await fetch("https://crud-voice-production.up.railway.app/transcribe", {
            method: "POST",
            body: formData
          });

          const data = await response.json();
          result.textContent = data.text;
          lastTranscribedText = data.text;

          processBtn.disabled = false;
          status.textContent = "Ready to process command!";
        } catch (err) {
          status.textContent = "Error: " + err;
        }
      };

      mediaRecorder.start();
      status.textContent = "Recording...";
      startBtn.disabled = true;
      stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      stopBtn.disabled = true;
      startBtn.disabled = false;
      status.textContent = "Stopping...";
    };

    // ---------- PROCESS COMMAND ----------
    processBtn.onclick = async () => {
      try {
        const response = await fetch("https://crud-voice-production.up.railway.app/process_command", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: lastTranscribedText })
        });

        const data = await response.json();
        if (data.error) {
          status.textContent = "Error: " + data.detail;
        } else {
          // Render todo list as a table
          renderTable(data.todo_list);
          status.textContent = "Command processed!";
        }

        processBtn.disabled = true;
      } catch (err) {
        status.textContent = "Error: " + err;
      }
    };
  </script>
</body>
</html>
